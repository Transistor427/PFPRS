[force_move]
enable_force_move: True

[gcode_shell_command POWER_LOSS_RESUME_CURR]
command: /home/pi/printer_data/config/klipper-config/pfprs/curr_layer.sh
timeout: 5
verbose: True

[gcode_shell_command POWER_LOSS_RESUME_NEXT]
command: /home/pi/printer_data/config/klipper-config/pfprs/next_layer.sh
timeout: 5
verbose: True

[gcode_macro _RESUME_INTERRUPTED_CURR]
description: Продолжить печать с текущего слоя последнего запущенного файла.
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set z_height = params.Z_HEIGHT|default(svv.pr_z)|float %}
    {% set last_file = params.GCODE_FILE|default(svv.pr_file)|string %}
    {% if last_file != 'None' %}
        _PROMPT_END
        RUN_SHELL_COMMAND CMD=POWER_LOSS_RESUME_CURR PARAMS="{z_height} {last_file}"
        SDCARD_PRINT_FILE FILENAME=restore.gcode
    {% else %}
        RESPOND TYPE=error MSG="Файл для восстановления не найден!"
        _PROMPT_END
    {% endif %}

[gcode_macro _RESUME_INTERRUPTED_NEXT]
description: Продолжить печать со следующего слоя последнего запущенного файла.
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set z_height = params.Z_HEIGHT|default(svv.pr_z)|float %}
    {% set last_file = params.GCODE_FILE|default(svv.pr_file)|string %}
    {% if last_file != 'None' %}
        _PROMPT_END
        RUN_SHELL_COMMAND CMD=POWER_LOSS_RESUME_NEXT PARAMS="{z_height} {last_file}"
        SDCARD_PRINT_FILE FILENAME=restore.gcode
    {% else %}
        RESPOND TYPE=error MSG="Файл для восстановления не найден!"
        _PROMPT_END
    {% endif %}

[gcode_macro _LOG_Z]
gcode:
    {% set svv = printer.save_variables.variables %}                            
    {% set z_pos = printer.gcode_move.gcode_position.z %}
    {% set t_extruder = printer.extruder.target %}
	{% if printer.extruder1 %}
        {% if printer.extruder1.target > 0 %}
            {% set t_extruder1 = printer.extruder1.target %}
        {% endif %}
        {% set active_ext = printer.toolhead.extruder %}
    {% endif %}
    {% set t_bed = printer.heater_bed.target %}
    {% set t_chamb = printer['temperature_sensor Chamber'].temperature %}
    {% set last_filepath = printer.virtual_sdcard.file_path %}  
    SAVE_VARIABLE VARIABLE=pr_z VALUE={z_pos}
    SAVE_VARIABLE VARIABLE=pr_t_ext VALUE={t_extruder}
    {% if printer.extruder1 %}
        {% if printer.extruder1.target > 0 %}
            SAVE_VARIABLE VARIABLE=pr_t_ext1 VALUE={t_extruder1}
        {% endif %}
        SAVE_VARIABLE VARIABLE=pr_act_ext VALUE={active_ext}
    {% endif %}
    SAVE_VARIABLE VARIABLE=pr_t_bed VALUE={t_bed}
    SAVE_VARIABLE VARIABLE=pr_t_chamb VALUE={t_chamb}
    {% if last_filepath != '/home/pi/printer_data/gcodes/restore.gcode' %}
        SAVE_VARIABLE VARIABLE=pr_file VALUE="'{last_filepath}'"
    {% endif %}

[gcode_macro _START_PRINT_RESTORE]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set Z_POS = svv.pr_z %}
    {% set T_BED = svv.pr_t_bed %}
    {% set T_EXTRUDER = svv.pr_t_ext %}
    {% set T_EXTRUDER1 = svv.pr_t_ext1 %}
    {% set ACTIVE_EXT = svv.pr_act_ext %}
    {% set T_CHAMBER = svv.pr_t_chamb %}
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
    RESPOND PREFIX="[+]" MSG="Установлена высота по оси Z - {Z_POS}"
    SET_KINEMATIC_POSITION Z={Z_POS}
    G4 P2000
    RESPOND PREFIX="[+]" MSG="Запуск печати файла восстановления" 
    {% if printer.extruder1 %}
        {% if ACTIVE_EXT == extruder and printer.extruder.temperature >= 190 %}
            G28 X
            G28 Y
        {% endif %}
        {% if ACTIVE_EXT == extruder1 and printer.extruder1.temperature >= 190 %}
            G28 X
            G28 Y
        {% endif %}
    {% else %}
        {% if printer.extruder.temperature >= 190 %}
            G28 X
            G28 Y
        {% endif %}    
    {% endif %}
    {% if T_CHAMBER != 0 %} 
        RESPOND PREFIX="[+]" MSG="Включен нагрев камеры до рабочей температуры"
        SET_HEATER_TEMPERATURE HEATER=chamber TARGET={T_CHAMBER}
    {% endif %}

    {% if printer.extruder1 %}
        RESPOND PREFIX="[+]" MSG="Включен нагрев первой головы до {T_EXTRUDER}" 
        M104 S{T_EXTRUDER}
        G4 P2000
        {% if T_EXTRUDER1 >= 180 %}
        RESPOND PREFIX="[+]" MSG="Включен нагрев второй головы до {T_EXTRUDER1}" 
        M104 S{T_EXTRUDER}
        G4 P2000

    {% else %}
        RESPOND PREFIX="[+]" MSG="Включен нагрев хотенда до {T_EXTRUDER}" 
        M104 S{T_EXTRUDER}
    G4 P2000
    {% endif %}
    G4 P2000
    RESPOND PREFIX="[+]" MSG="Включен нагрев стола до {T_BED}"  
    M140 S{T_BED}
    M109 S{T_EXTRUDER}
    M190 S{T_BED}
    RESPOND PREFIX="[+]" MSG="Нагрев завершен"
    G4 P2000
    RESPOND PREFIX="[+]" MSG="Продолжаем печать"  
    G91
    G1 Z5
    G90
    {% if "xy" not in printer.toolhead.homed_axes %}
        G28 X
        G28 Y
    {% endif %}
    G91
    G1 Z-5
    G90
    G21
    M83
    RESPOND PREFIX="[+]" MSG="Начало печати" 

[delayed_gcode _DELAY_SHOW_RESUME_INTERRUPTED]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if svv.was_interrupted%}
        SHOW_RESUME_INTERRUPTED
    {% endif %}
initial_duration: 25.0

[gcode_macro _PROMPT_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro SHOW_RESUME_INTERRUPTED]
description: Возобновление последней печати в случае аварийной остановки или кратковременного отключения питания.
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if svv.was_interrupted%}
        RESPOND TYPE=command MSG="action:prompt_begin Возобновление печати"
        RESPOND TYPE=command MSG="action:prompt_text Печать была прервана. Продолжить последнюю печать? *Убедитесь, что стол не сместился и деталь не отлипла!"
        RESPOND TYPE=command MSG="action:prompt_footer_button Возобновить|_SELECT_LAYER|primary"
        RESPOND TYPE=command MSG="action:prompt_footer_button Отмена|_PROMPT_END|warning"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        RESPOND TYPE=error MSG="Отсутствует файл для возобновления! Сначала необходимо запустить печать!"
    {% endif %}

[gcode_macro _SELECT_LAYER]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin Возобновление печати"
    RESPOND TYPE=command MSG="action:prompt_text С какого слоя возобновить печать? *Если принтер только начал печатать слой, то выберите 'Текущий слой'. В ином случае 'Следующий слой'!"
    RESPOND TYPE=command MSG="action:prompt_footer_button Текущий слой|_RESUME_INTERRUPTED_CURR|primary"
    RESPOND TYPE=command MSG="action:prompt_footer_button Следующий слой|_RESUME_INTERRUPTED_NEXT|secondary"
    RESPOND TYPE=command MSG="action:prompt_footer_button Отмена|_PROMPT_END|warning"
    RESPOND TYPE=command MSG="action:prompt_show"
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
