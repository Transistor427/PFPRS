# PFPRS - Power Failure Print Recovery System

Конфигурационный и исполняемый файлы для добавления фунции восстановления печати после отключения питания или аварийной остановки.

## Установка
 ```
cd ~
git clone https://github.com/Transistor427/PFPRS/
sudo chmod 777 ~/PFPRS/curr_layer.sh ~/PFPRS/next_layer.sh
sudo ln -s ~/PFPRS ~/printer_data/config/klipper-config/pfprs
```

Веб-интерфейс > Конфигурация > printer.cfg
```
[include klipper-config/pfprs/pfprs.cfg]
```
## Дополнительные действия
Проверяем, что установлен правильный kiauh:
```
ls ~/kiauh-zb/
```
Если вывод такой, то выполним установку kiauh:

![изображение](https://github.com/user-attachments/assets/995b7dc1-649c-4e45-acb2-134fe3e76c1a)
```
cd ~
git clone https://github.com/Z-Bolt/kiauh-zb -b Z-BoltUI3.1
```
Снова проверяем правильность kiauh.
Если такой, то продолжаем дальше:

![изображение](https://github.com/user-attachments/assets/f725352f-541f-4ea9-a9e1-f5e6734637e4)

```
~/kiauh-zb/kiauh.sh
```
Далее выбираем:
```
4) [Advanced]
8) [G-Code Shell Command]
```
Соглашаемся с рисками (y).
Отказываемся от создания файла-примера (n). 

Обновляем KlipperScreen:
```
cd ~/KlipperScreen && git pull && git checkout Z-BoltUI3.1-Restore_Print && sudo systemctl restart KlipperScreen
```

## Настройка конфигурационных файлов
Веб-интерфейс > Конфигурация > klipper-config > gcode-macros.cfg > [gcode_macro START_PRINT]

![изображение](https://github.com/user-attachments/assets/661d21c9-7a97-4ff7-a899-07218cf9e807)

Добавляем в самый конец стартового g-кода строчку:
```
SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
```

Веб-интерфейс > Конфигурация > klipper-config > gcode-macros.cfg > [gcode_macro END_PRINT]

![изображение](https://github.com/user-attachments/assets/1285a067-926a-4fa8-86ad-836df7c23e1c)

Добавляем в самое начало конечного g-кода строчку:
```
SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
```

## Настройка OrcaSlicer
В слайсере в g-кодах принтера при смене слоев нужно добавить макрос `_LOG_Z`:

![изображение](https://github.com/user-attachments/assets/6b2c2790-d9e0-4363-9f62-3de80d8da48d)

## Алгоритм восстановления печати
### Подготовка
1) Запускаем G-код с модифицированным макросом `_LOG_Z`
2) Выполнение аварийной остановки или кратковременного отключения питания (симуляция реального экстренного выключения (нажатие на кнопку аварийной остановки) или отключения питания (выдергиваем шнур питания и вставляем обратно)
3) После загрузки принтера проверяем, чтобы стол не сместился вниз
### Восстановление через KlipperScreen
1) Если стол сместился, то вручную включаем нагрев хотенда, стола и камеры (если использовалась), далее переходим в меню "Движение" > меню "Действия" > панель "Аварийные перемещения" > Соглашаемся с риском > кнопка "Установить Z в максимум" > далее двигаем стол вверх, пока не вернем кончик сопла на тот же уровень, который был до отключения > кнока "Установить позицию Z в 0" > кнопка "Возобновить" (иконка с кругом в который вписан треугольник) > кнопка "Возобновить" > выбираем текущий или предыдущий слой > ожидаем парковки, нагрева до целевых температур и возобновление печати (при необходимости подправляем высоту через панель "Точная настройка")
2) Если стол не сместился, то переходим в меню "Движение" > меню "Действия" > панель "Аварийные перемещения" > кнопка "Возобновить" (иконка с кругом в который вписан треугольник) > кнопка "Возобновить" > выбираем текущий или предыдущий слой > ожидаем парковки, нагрева до целевых температур и возобновление печати (при необходимости подправляем высоту через панель "Точная настройка")
### Восстановление через Fluidd
1) Если стол сместился, то вручную включаем нагрев хотенда, стола и камеры (если использовалась), далее нажимаем кнопку "SET_Z_MAX_POSITION" (или "Установить Z в максимум") в блоке "Макросы" > далее двигаем стол вверх, пока не вернем кончик сопла на тот же уровень, который был до отключения > нажимаем кнопку "SET_Z_ZERO_POSITION" (или "Установить позицию Z в 0") в блоке "Макросы" > нажимаем кнопку "SHOW_RESUME_INTERRUPTED" (или "Возобновить печать") в блоке "Макросы" > выбираем текущий или предыдущий слой > ожидаем парковки, нагрева до целевых температур и возобновление печати (при необходимости подправляем высоту)
2) Если стол не сместился, то нажимаем кнопку "SHOW_RESUME_INTERRUPTED" (или "Возобновить печать") в блоке "Макросы" > выбираем текущий или предыдущий слой > ожидаем парковки, нагрева до целевых температур и возобновление печати (при необходимости подправляем высоту)
---
Обратите внимание, что даже если визуально кажется, что стол не опустился, в реальности он опустился вниз на 0.1-0.3мм, поэтому лучше всего поднять стол как раз на эти 0.1-0.3 мм ближе к соплу, после чего восстановить печать.
---
## Описание процесса работы
После запуска g-кода каждый раз при смене слоя вызывается макрос `_LOG_Z`, который сохраняет текущую высоту слоя, температуру хотенда и стола, а также название печатаемого файла.
При запуске печати значение переменной `was_interrupted` устанавливается в `True`. Если при печати (до выполнения конечного g-кода, где значение переменной станет False) произойдет отключение питания или будет нажата кнопка аварийной остановки, то при возвращении принтера в рабочее состояние (включение питания или перезагрузка) можно будет вызвать макрос `RESUME_INTERRUPTED`, который запустит скрипт, а также передвинуть ось Z 
Скрипт в свою очередь выполняет следующее:
- согласно высоте по Z, которая записана в переменной, файл будет обрезан с начала до следующего по счету слоя и переназван "restore.gcode" (т.е. если слой 0.2 мм, а отключилось питание на высоте 0.8 мм, то печать продолжиться с высоты 1.0 мм), а также добавлен стартовый g-код восстановления `_START_PRINT_RESTORE`, который выполнит парковку осей и нагрев хотенда и стола до рабочих температур;
- после выполнения стартового g-кода восстановления `_START_PRINT_RESTORE` печать продолжится с последнего сохраненного места.

## Ограничения
Из-за того, что после отключения питания отключается и нагрев хотенда со столом, то при длительном простое принтера деталь может отлипнуть, поэтому рекомендуется пользоваться данной функцией только в случае кратковременного отключения питания (не более 5 минут), так как за малый промежуток времени деталь не успеет отлипнуть от стола. В ином случае результат может быть непредсказуемым. 
В зависимости от того, в какой момент происходит прерывание печати (в начале слоя, в процессе печати слоя или при его окончании) важно понимать, что принтер сохраняет только позицию по оси Z и не знает, в каком именно месте остановилась голова. Из-за этого на операторе лежит ответственность за выбор, с какого слоя продолжить печать, с текущего или со следующего. Возобновлять печать с текущего слоя рекомендуется только в случаях отключения принтера в начале печати слоя. Если слой уже достаточно много пропечатался, то запуск возобновления с текущего слоя может привести к переэкструзии и повышенному вдавливанию филамента в уже распечатанную часть слоя, что может привести к смещениям или излому термобарьера. Запуск со следующего слоя возобновить печать со следующего по счету слоя на момент записи данных. Это позволит избежать переэкструзии и повреждения хотенда, но может оставить непропечатанным часть слоя, что скажется на внешнем виде изделия, а также его прочностных характеристиках (разрыв по слоям в месте недопечатанного слоя).

## Удаление
В процессе...
