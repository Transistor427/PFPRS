# PFPRS - Power Failure Print Recovery System

Конфигурационный и исполняемый файлы для добавления фунции восстановления печати после отключения питания или аварийной остановки.

## Установка
 ```
cd ~
git clone https://github.com/Transistor427/PFPRS/
sudo chmod 777 ~/PFPRS/curr_layer.sh ~/PFPRS/next_layer.sh
sudo ln -s ~/PFPRS ~/printer_data/config/klipper-config/pfprs
```

Веб-интерфейс > Конфигурация > printer.cfg
```
[include klipper-config/pfprs/pfprs.cfg]
```
## Дополнительные действия
Проверяем, что установлен правильный kiauh:
```
ls ~/kiauh-zb/
```
Если вывод такой, то выполним установку kiauh:
![изображение](https://github.com/user-attachments/assets/995b7dc1-649c-4e45-acb2-134fe3e76c1a)
```
cd ~
git clone https://github.com/Z-Bolt/kiauh-zb -b Z-BoltUI3.1
```
Снова проверяем правильность kiauh.
Если такой, то продолжаем дальше:
![изображение](https://github.com/user-attachments/assets/f725352f-541f-4ea9-a9e1-f5e6734637e4)

```
~/kiauh-zb/kiauh.sh
```
Далее выбираем:
```
4) [Advanced]
8) [G-Code Shell Command]
```
Соглашаемся с рисками (y).
Отказываемся от создания файла-примера (n). 

## Настройка конфигурационных файлов
Веб-интерфейс > Конфигурация > klipper-config > gcode-macros.cfg > [gcode_macro START_PRINT]

![изображение](https://github.com/user-attachments/assets/661d21c9-7a97-4ff7-a899-07218cf9e807)

Добавляем в самый конец стартового g-кода строчку:
```
SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
```

Веб-интерфейс > Конфигурация > klipper-config > gcode-macros.cfg > [gcode_macro END_PRINT]

![изображение](https://github.com/user-attachments/assets/1285a067-926a-4fa8-86ad-836df7c23e1c)

Добавляем в самое начало конечного g-кода строчку:
```
SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
```

## Настройка OrcaSlicer
В слайсере в g-кодах принтера при смене слоев нужно добавить макрос `_LOG_Z`:

![изображение](https://github.com/user-attachments/assets/6b2c2790-d9e0-4363-9f62-3de80d8da48d)

## Использование и тестирование
Для проверки работы возобновления печати подготовьте g-код в модифицированном слайсере и запустите его на принтере. Подождите, пока принтер напечатает несколько слоев и нажмите кнопку "Аварийной остановки" или отключите шнур питания от принтера.Перезагрузите прошику или включите обратно шнур питания.
После включения принтера на экране появится сообщение о том, что печать была прервана. При нажатии на кнопку "Возобновить" появится следующее сообщение, в котором нужно выбрать, с какого слоя будет продолжаться печать. После выбора слоя будет создат новый файл restore.gcode и автоматически отправлен в печать. 

## Описание процесса работы
После запуска g-кода каждый раз при смене слоя вызывается макрос `_LOG_Z`, который сохраняет текущую высоту слоя, температуру хотенда и стола, а также название печатаемого файла.
При запуске печати значение переменной `was_interrupted` устанавливается в `True`. Если при печати (до выполнения конечного g-кода, где значение переменной станет False) произойдет отключение питания или будет нажата кнопка аварийной остановки, то при возвращении принтера в рабочее состояние (включение питания или перезагрузка) можно будет вызвать макрос `RESUME_INTERRUPTED`, который запустит скрипт.
Скрипт в свою очередь выполняет следующее:
- согласно высоте по Z, которая записана в переменной, файл будет обрезан с начала до следующего по счету слоя и переназван "restore.gcode" (т.е. если слой 0.2 мм, а отключилось питание на высоте 0.8 мм, то печать продолжиться с высоты 1.0 мм), а также добавлен стартовый g-код восстановления `_START_PRINT_RESTORE`, который выполнит парковку осей и нагрев хотенда и стола до рабочих температур;
- после выполнения стартового g-кода восстановления `_START_PRINT_RESTORE` печать продолжится с последнего сохраненного места.

## Ограничения
Из-за того, что после отключения питания отключается и нагрев хотенда со столом, то при длительном простое принтера деталь может отлипнуть, поэтому рекомендуется пользоваться данной функцией только в случае кратковременного отключения питания (не более 5 минут), так как за малый промежуток времени деталь не успеет отлипнуть от стола. В ином случае результат может быть непредсказуемым. 


## Удаление
В процессе...
