# PFPRS - Power Failure Print Recovery System

Конфигурационный и исполняемый файлы для добавления фунции восстановления печати после отключения питания или аварийной остановки.

## Установка
 ```
cd ~
git clone https://github.com/Transistor427/PFPRS/
cd PFPRS
sudo chmod 777 pfprs.sh
mkdir ~/printer_data/config/klipper-config/pfprs
sudo cp -r ./* ~/printer_data/config/klipper-config/pfprs
```

Веб-интерфейс > Конфигурация > printer.cfg

```
[include klipper-config/pfprs/pfprs.cfg]
```
## Дополнительные действия
```
~/kiauh-zb/kiauh.sh
```
Далее выбираем:
```
4) [Advanced]
8) [G-Code Shell Command]
```
Соглашаемся с рисками (y).
Отказываемся от создания файла-примера (n). 

## Настройка конфигурационных файлов
Веб-интерфейс > Конфигурация > klipper-config > gcode-macros.cfg > [gcode_macro START_PRINT]

![изображение](https://github.com/user-attachments/assets/661d21c9-7a97-4ff7-a899-07218cf9e807)

Добавляем в самый конец стартового g-кода строчку:
```
SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
```

Веб-интерфейс > Конфигурация > klipper-config > gcode-macros.cfg > [gcode_macro END_PRINT]

![изображение](https://github.com/user-attachments/assets/1285a067-926a-4fa8-86ad-836df7c23e1c)

Добавляем в самое начало конечного g-кода строчку:
```
SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
```

## Настройка слайсера
В слайсере в g-кодах принтера при смене слоев нужно добавить макрос `_LOG_Z`:

![изображение](https://github.com/user-attachments/assets/6b2c2790-d9e0-4363-9f62-3de80d8da48d)

## Описание процесса работы
После запуска g-кода каждый раз при смене слоя вызывается макрос `_LOG_Z`, который сохраняет текущую высоту слоя, температуру хотенда и стола, а также название печатаемого файла.
При запуске печати значение переменной `was_interrupted` устанавливается в `True`. Если при печати (до выполнения конечного g-кода, где значение переменной станет False) произойдет отключение питания или будет нажата кнопка аварийной остановки, то при возвращении принтера в рабочее состояние (включение питания или перезагрузка) можно будет вызвать макрос `RESUME_INTERRUPTED`, который запустит скрипт.
Скрипт в свою очередь выполняет следующее:
- согласно высоте по Z, которая записана в переменной, файл будет обрезан с начала до следующего по счету слоя и переназван "restore.gcode" (т.е. если слой 0.2 мм, а отключилось питание на высоте 0.8 мм, то печать продолжиться с высоты 1.0 мм), а также добавлен стартовый g-код восстановления `_START_PRINT_RESTORE`, который выполнит парковку осей и нагрев хотенда и стола до рабочих температур;
- после выполнения стартового g-кода восстановления `_START_PRINT_RESTORE` печать продолжится с последнего сохраненного места.

## Ограничения
Из-за того, что после отключения питания отключается и нагрев хотенад со столом при длительном простое принтера деталь может отлипнуть, поэтому рекомендуется пользоваться данной функцией только в случае кратковременного отключения питания (не более 5 минут), так как за малый промежуток времени деталь не успеет отлипнуть от стола. В ином случае результат может быть непредсказуемым. 
